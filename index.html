<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>大 PDF 按需渲染</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    </script>

    <style>
      * {
        &::-webkit-scrollbar {
          width: 1px;
          height: 1px;
        }

        ::-webkit-scrollbar-track {
          border-radius: 4px;
          background-color: transparent;
        }

        &::-webkit-scrollbar-thumb {
          background-color: var(white);
          border-radius: 4px;

          &:hover {
            background-color: var(white);
          }
        }
      }
      body {
        margin: 0px;
        position: relative;
        width: 100vw;
        height: 100vh;
      }

      #pdfContainer {
        width: 100%;
        margin: 0 auto;
        overflow-x: hidden; /* 防止横向溢出 */
        /* 新增：强制显示纵向滚动条，设置最小高度确保可滚动 */
        overflow-y: scroll; /* 始终显示纵向滚动条（即使内容不足） */
        min-height: 100vh; /* 容器最小高度为屏幕高度，确保至少有滚动区域 */
      }

      #loading {
        text-align: center;
        position: fixed;
        right: 20px;
        bottom: 20px;
        background-color: black;
        color: white;
        z-index: 20;
        padding: 5px 20px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <!-- 容器用于承载所有 PDF 页面（Canvas） -->
    <div id="pdfContainer"></div>
    <!-- 加载状态提示 -->
    <div id="loading">加载中...</div>

    <script>
      const container = document.getElementById("pdfContainer");
      const loading = document.getElementById("loading");
      let pdfDoc = null;
      let totalPages = 0;
      let loadedPages = 0;
      let pageScale = 1;
      const pageSizes = []; // 存储每一页的原始宽高 [{width, height}, ...]
      const dpr = window.devicePixelRatio || 1;
      const loadedPageNumbers = new Set();
      let isRendering = false;

      // 计算容器可用宽度（扣除滚动条）
      function getContainerAvailableWidth() {
        const containerWidth = container.offsetWidth;
        const clientWidth = container.clientWidth;
        const scrollbarWidth = containerWidth - clientWidth;
        return clientWidth - (scrollbarWidth > 0 ? scrollbarWidth : 0);
      }

      // 防抖函数
      function debounce(func, wait = 200) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // 初始化PDF：先获取所有页宽高，再计算初始加载页数
      async function initPdf(url) {
        try {
          loading.textContent = "获取PDF信息中...";
          const loadingTask = pdfjsLib.getDocument({
            url: url,
            maxCanvasPixels: 4096 * 4096,
          });
          pdfDoc = await loadingTask.promise;
          totalPages = pdfDoc.numPages;

          // 获取所有页原始宽高
          for (let i = 1; i <= totalPages; i++) {
            const page = await pdfDoc.getPage(i);
            const viewport = page.getViewport({ scale: 1 });
            pageSizes.push({ width: viewport.width, height: viewport.height });
          }

          // 计算显示器可视高度
          const screenHeight = window.innerHeight;
          // 计算缩放比例
          const availableWidth = getContainerAvailableWidth();
          pageScale = availableWidth / pageSizes[0].width;

          // 计算初始加载页数（核心修改）
          let totalHeight = 0;
          let initialLoadPages = 0;
          for (let i = 0; i < pageSizes.length; i++) {
            const scaledHeight = pageSizes[i].height * pageScale;
            totalHeight += scaledHeight;
            initialLoadPages++;
            // 当累加高度接近屏幕高度时，多加载1页
            if (totalHeight >= screenHeight * 0.9) {
              initialLoadPages++; // 强制多加载1页，确保超出屏幕
              break;
            }
          }
          // 确保不超过总页数，且至少加载1页
          initialLoadPages = Math.max(
            1,
            Math.min(initialLoadPages, totalPages)
          );

          loading.textContent = `共 ${totalPages} 页，初始加载 ${initialLoadPages} 页...`;
          await renderPages(1, initialLoadPages);
        } catch (err) {
          loading.textContent = `加载失败：${err.message}`;
        }
      }
      // 渲染指定页面
      async function renderPages(start, end) {
        if (isRendering) return;
        isRendering = true;

        end = Math.min(end, totalPages);
        try {
          const availableWidth = getContainerAvailableWidth();
          pageScale = availableWidth / pageSizes[0].width; // 重新计算缩放

          for (let num = start; num <= end; num++) {
            if (loadedPageNumbers.has(num)) continue;
            const existingPage = container.querySelector(
              `[data-page-num="${num}"]`
            );
            if (existingPage) {
              loadedPageNumbers.add(num);
              continue;
            }

            // 按当前页原始尺寸渲染（支持不同页宽高）
            const page = await pdfDoc.getPage(num);
            const scaledViewport = page.getViewport({ scale: pageScale * dpr });

            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");

            canvas.width = scaledViewport.width;
            canvas.height = scaledViewport.height;
            canvas.style.width = `${scaledViewport.width / dpr}px`;
            canvas.style.height = `${scaledViewport.height / dpr}px`;
            canvas.style.maxWidth = `${availableWidth}px`;
            canvas.style.display = "block";
            canvas.style.margin = "0 auto";
            canvas.style.padding = "0";
            canvas.style.border = "none";
            canvas.dataset.pageNum = num;
            container.appendChild(canvas);

            context.imageSmoothingEnabled = true;
            context.imageSmoothingQuality = "high";

            const renderContext = {
              canvasContext: context,
              viewport: scaledViewport,
            };
            await page.render(renderContext).promise;

            loadedPages = Math.max(loadedPages, num);
            loadedPageNumbers.add(num);
            loading.textContent = `已加载 ${loadedPages}/${totalPages} 页`;

            if (loadedPages >= totalPages) {
              loading.textContent = "加载完成";
              setTimeout(() => (loading.style.display = "none"), 3000);
            }
          }
        } catch (err) {
          console.error("渲染失败：", err);
        } finally {
          isRendering = false;
        }
      }

      // 窗口大小变化处理
      function handleResize() {
        if (pdfDoc && pageSizes.length) {
          Array.from(container.querySelectorAll("canvas")).forEach((canvas) => {
            container.removeChild(canvas);
          });
          loadedPageNumbers.clear();
          loadedPages = 0;
          // 重新计算初始加载页数
          const screenHeight = window.innerHeight;
          let totalHeight = 0;
          let initialLoadPages = 0;
          for (let i = 0; i < pageSizes.length; i++) {
            const scaledHeight = pageSizes[i].height * pageScale;
            totalHeight += scaledHeight;
            initialLoadPages++;
            if (totalHeight >= screenHeight * 0.9) {
              initialLoadPages++; // 多加载1页
              break;
            }
          }
          initialLoadPages = Math.max(
            1,
            Math.min(initialLoadPages, totalPages)
          );
          renderPages(1, initialLoadPages);
        }
      }
      // 滚动加载
      const handleScroll = debounce(function () {
        if (loadedPages >= totalPages || isRendering) return;

        const lastPage = container.querySelector(
          `[data-page-num="${loadedPages}"]`
        );
        if (!lastPage) return;

        const lastPageBottom = lastPage.getBoundingClientRect().bottom;
        const viewportHeight = window.innerHeight;

        if (lastPageBottom < viewportHeight + 500) {
          // 每次滚动加载2页（可调整）
          renderPages(loadedPages + 1, loadedPages + 2);
        }
      });

      window.addEventListener("scroll", handleScroll);
      window.addEventListener("resize", debounce(handleResize, 300));

      initPdf("./totalPdf.pdf"); // 替换为你的 PDF 地址
    </script>
  </body>
</html>
